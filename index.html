<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸˆ çŒ«å·´å£«çš„åµ‡é¥­é£Ÿå ‚</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* ä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²é…ç½®ï¼Œå¼ºåŒ–ç´«è‰²ç³» */
        :root {
            --color-primary: #8B5CF6; /* Violet 500 */
            --color-primary-dark: #7C3AED; /* Violet 600 */
        }
        .text-primary { color: var(--color-primary); }
        .bg-primary { background-color: var(--color-primary); }
        .bg-primary-dark { background-color: var(--color-primary-dark); }
        .border-primary { border-color: var(--color-primary); }

        body { 
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; 
            background-color: #f3f4f6; 
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ - ç®€çº¦å¯çˆ±ç´«è‰² */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #dcd0f9; border-radius: 4px; } /* æµ…ç´«è‰² */
        ::-webkit-scrollbar-track { background: #f1f5f9; }

        /* è¦†ç›–é»˜è®¤çš„ focus æ ·å¼ï¼Œç»Ÿä¸€ä½¿ç”¨ç´«è‰² */
        .focus-ring-primary:focus {
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--color-primary);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow);
            border-color: var(--color-primary);
        }
        /* éšè—æ‰‹æœºç«¯çš„æ¨ªå‘æ»šåŠ¨æ¡ï¼Œè®©ä½“éªŒæ›´åƒæ»‘åŠ¨ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-primary">ğŸˆ çŒ«å·´å£«çš„åµ‡é¥­é£Ÿå ‚</span>
                </div>
                <div class="flex space-x-4">
                    <button @click="currentTab = 'plan'" :class="{'text-primary border-b-2 border-primary': currentTab === 'plan'}" class="px-3 py-2 font-medium text-gray-600 hover:text-primary transition">ğŸ“… æœ¬å‘¨é¸¡é¥­è®¡åˆ’</button>
                    <button @click="currentTab = 'inventory'" :class="{'text-primary border-b-2 border-primary': currentTab === 'inventory'}" class="px-3 py-2 font-medium text-gray-600 hover:text-primary transition">ğŸ“¦ é£Ÿæåº“å­˜</button>
                    <button @click="currentTab = 'recipes'" :class="{'text-primary border-b-2 border-primary': currentTab === 'recipes'}" class="px-3 py-2 font-medium text-gray-600 hover:text-primary transition">ğŸ“– èœè°±ç®¡ç†</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full">
        
        <div v-if="currentTab === 'plan'" class="space-y-6">
            
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">æœ¬å‘¨é¸¡é¥­è®¡åˆ’</h2>
                    <p class="text-sm text-gray-500">æ•°æ®æ¥æºï¼š{{ isDataLoaded ? 'äº‘æ•°æ®åº“' : 'åŠ è½½ä¸­...' }}</p>
                </div>
                <button @click="clearPlan" class="text-sm text-red-500 hover:underline">æ¸…ç©ºæœ¬å‘¨è®¡åˆ’</button>
            </div>

            <div class="overflow-x-auto hide-scrollbar">
                <div 
                    class="grid gap-4 w-fit pb-4" 
                    :class="{
                        'grid-cols-7': isDesktop, 
                        'grid-flow-col auto-cols-[80%] sm:auto-cols-[50%] md:auto-cols-min': !isDesktop
                    }"
                >
                    <div 
                        v-for="dayData in datedWeekDays" 
                        :key="dayData.dateStr" 
                        class="bg-white rounded-xl shadow-md border border-gray-200 flex flex-col min-w-[280px] md:min-w-0 md:w-full h-[400px] transition duration-300"
                        :class="{
                            'border-2 border-primary shadow-lg': dayData.isToday,
                            'opacity-60 grayscale': dayData.isPast && plan[dayData.dayName].every(m => m.status === 'å·²åˆ¶ä½œ')
                        }"
                    >
                        <div class="p-3 bg-violet-50 rounded-t-xl border-b border-gray-100 font-bold text-center text-gray-700">
                            {{ dayData.dayName }}
                            <div class="text-sm font-normal text-gray-500">{{ dayData.displayDate }}</div>
                        </div>
                        
                        <div class="flex-1 p-2 overflow-y-auto space-y-2">
                            <div v-for="(meal, mIndex) in plan[dayData.dayName]" :key="mIndex" 
                                class="group relative bg-white border border-gray-200 rounded-lg p-2 shadow-sm hover:shadow-md transition"
                                :class="{'bg-violet-100 border-violet-400': meal.status === 'å·²åˆ¶ä½œ'}"
                            >
                                <div class="flex justify-between items-start">
                                    <button @click="viewRecipeDetail(meal.id)" class="font-medium text-gray-800 text-left hover:text-primary underline decoration-dashed decoration-gray-400">
                                        {{ getRecipeName(meal.id) }}
                                    </button>
                                    <button @click="removeFromPlan(dayData.dayName, mIndex)" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100">Ã—</button>
                                </div>

                                <div class="mt-2 flex items-center justify-between">
                                    <span :class="{'text-primary-dark font-semibold': meal.status === 'å·²åˆ¶ä½œ', 'text-gray-500': meal.status === 'æœªåˆ¶ä½œ'}" class="text-xs">
                                        çŠ¶æ€: {{ meal.status }}
                                    </span>
                                    <button 
                                        @click="toggleRecipeStatus(dayData.dayName, mIndex)" 
                                        :class="{'bg-primary hover:bg-primary-dark': meal.status === 'æœªåˆ¶ä½œ', 'bg-red-500 hover:bg-red-600': meal.status === 'å·²åˆ¶ä½œ'}"
                                        class="text-white text-xs px-2 py-1 rounded transition"
                                    >
                                        {{ meal.status === 'æœªåˆ¶ä½œ' ? 'æ ‡è®°ä¸ºå·²åˆ¶ä½œ' : 'æ ‡è®°ä¸ºæœªåˆ¶ä½œ' }}
                                    </button>
                                </div>

                                <div class="mt-1 text-xs text-gray-500 truncate">
                                    {{ getRecipeIngredientsStr(meal.id) }}
                                </div>
                            </div>
                            
                            <button @click="openMealSelector(dayData.dayName)" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 hover:border-primary hover:text-primary transition text-sm">
                                + æ·»åŠ 
                            </button>
                        </div>

                        <div class="p-2 border-t border-gray-100">
                            <button @click="viewDayDetail(dayData.dayName)" class="w-full text-xs text-center text-blue-500 hover:text-blue-700">
                                æŸ¥çœ‹{{ dayData.dayName }}æ¶ˆè€—æ±‡æ€»
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-red-400">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        ğŸ›’ è´­ç‰©æ¸…å• (ç¼ºè´§)
                        <span v-if="shoppingList.length === 0" class="ml-2 text-xs font-normal bg-green-100 text-green-700 px-2 py-1 rounded">åº“å­˜å……è¶³</span>
                    </h3>
                    <div v-if="shoppingList.length > 0" class="space-y-2">
                        <div v-for="item in shoppingList" :key="item.name" 
                             :class="{
                                'bg-red-50 text-red-700 border-l-4 border-red-400': !item.optional,
                                'bg-yellow-50 text-yellow-700 border-l-4 border-yellow-400': item.optional
                             }"
                             class="flex justify-between items-center p-2 rounded"
                        >
                            <span>{{ item.name }} 
                                <span v-if="item.optional" class="text-xs font-normal">(å¯é€‰)</span>
                            </span>
                            <span class="font-bold">éœ€è´­ä¹°: {{ item.missing }} {{ item.unit }}</span>
                        </div>
                    </div>
                    <div v-else class="text-center py-8 text-gray-400">
                        å¤ªæ£’äº†ï¼ä½ çš„åº“å­˜è¶³å¤Ÿåˆ¶ä½œä»Šå¤©åŠæœªæ¥çš„è®¡åˆ’èœè‚´ã€‚
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-primary">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ½ï¸ æœ¬å‘¨å·²åˆ¶ä½œé£Ÿææ¶ˆè€—æ±‡æ€»</h3>
                    <div class="flex flex-wrap gap-2">
                        <span v-for="(item, name) in totalUsage" :key="name" class="px-3 py-1 bg-violet-100 rounded-full text-sm text-gray-700 border border-violet-200">
                            {{ name }}: {{ item.qty }} {{ item.unit }}
                        </span>
                        <span v-if="Object.keys(totalUsage).length === 0" class="text-gray-400 text-sm">æš‚æ— æ ‡è®°ä¸ºâ€œå·²åˆ¶ä½œâ€çš„èœå“æ¶ˆè€—è®°å½•</span>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'inventory'" class="max-w-6xl mx-auto bg-white rounded-xl shadow p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">å½“å‰é£Ÿæåº“å­˜</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-6 items-end">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">ç±»åˆ«</label>
                    <input 
                        v-model="newInvCategory" 
                        placeholder="é€‰æ‹©æˆ–è¾“å…¥è‡ªå®šä¹‰ç±»åˆ«" 
                        class="w-full border rounded-lg px-4 py-2 focus-ring-primary outline-none"
                        list="category-suggestions"
                    >
                    <datalist id="category-suggestions">
                        <option v-for="cat in Object.keys(CATEGORIES_MAP)" :key="cat" :value="cat"></option>
                    </datalist>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">é£Ÿæåç§°</label>
                    <input 
                        v-model="newInvName" 
                        placeholder="é€‰æ‹©æˆ–è‡ªå®šä¹‰åç§°" 
                        class="w-full border rounded-lg px-4 py-2 focus-ring-primary outline-none"
                        list="ingredient-suggestions"
                    >
                    <datalist id="ingredient-suggestions">
                        <template v-if="CATEGORIES_MAP[newInvCategory]">
                            <option v-for="name in CATEGORIES_MAP[newInvCategory].items" :key="name" :value="name"></option>
                        </template>
                    </datalist>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">æ•°é‡</label>
                    <input v-model.number="newInvQty" type="number" placeholder="æ•°é‡" class="w-full border rounded-lg px-4 py-2 focus-ring-primary outline-none">
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">å•ä½ (å¦‚: g/kg/ä»½)</label>
                    <input v-model="newInvUnit" placeholder="å•ä½" class="w-full border rounded-lg px-4 py-2 focus-ring-primary outline-none">
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">ä¿è´¨æœŸ (å¤©)</label>
                    <input v-model.number="newInvShelfLife" type="number" placeholder="é»˜è®¤å¤©æ•°" class="w-full border rounded-lg px-4 py-2 focus-ring-primary outline-none">
                </div>

                <button @click="addInventory" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-dark font-medium">æ·»åŠ å…¥åº“</button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-gray-500 border-b">
                            <th class="py-3 px-2">ç±»åˆ«</th>
                            <th class="py-3 px-2">é£Ÿæåç§°</th>
                            <th class="py-3 px-2">åº“å­˜é‡</th>
                            <th class="py-3 px-2">å…¥åº“æ—¥æœŸ</th>
                            <th class="py-3 px-2">ä¿è´¨æœŸ (å¤©)</th>
                            <th class="py-3 px-2">è¿‡æœŸçŠ¶æ€</th>
                            <th class="py-3 px-2 text-right">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, index) in inventory" :key="index" 
                            class="border-b last:border-0 hover:bg-gray-50 transition"
                            :class="checkExpirationStatus(item)"
                        >
                            <td class="py-3 px-2 font-medium text-gray-800">{{ item.category }}</td>
                            <td class="py-3 px-2 font-bold text-gray-800">{{ item.name }}</td>
                            <td class="py-3 px-2 text-sm">{{ item.qty }} {{ item.unit }}</td>
                            <td class="py-3 px-2 text-sm">{{ item.entryDate }}</td>
                            <td class="py-3 px-2">
                                <input v-model.number="item.shelfLife" type="number" class="w-16 border rounded px-1 py-0.5 text-sm text-center">
                            </td>
                            <td class="py-3 px-2 text-sm font-bold">
                                <span v-if="checkExpirationStatus(item) === 'expired'" class="text-red-600">å·²è¿‡æœŸ ({{ checkDaysLeft(item) }}å¤©å‰)</span>
                                <span v-else-if="checkExpirationStatus(item) === 'expiring-soon'" class="text-orange-600">å³å°†è¿‡æœŸ (å‰©{{ checkDaysLeft(item) }}å¤©)</span>
                                <span v-else class="text-green-600">æ–°é²œ</span>
                            </td>
                            <td class="py-3 px-2 text-right">
                                <div class="flex items-center justify-end space-x-2">
                                    <button @click="updateInventory(index, -item.qty)" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-sm">æ¸…ç©º</button>
                                    <button @click="deleteInventory(index)" class="text-gray-500 hover:bg-gray-200 px-2 py-1 rounded text-sm">åˆ é™¤</button>
                                </div>
                            </td>
                        </tr>
                        <tr v-if="inventory.length === 0">
                            <td colspan="7" class="text-center py-8 text-gray-400">æš‚æ— åº“å­˜ï¼Œè¯·æ·»åŠ é£Ÿæ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="currentTab === 'recipes'" class="max-w-7xl mx-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„ç§æˆ¿èœè°±</h2>
                <button @click="openRecipeEditor()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark flex items-center">
                    <span class="mr-1 text-xl">+</span> æ–°å»ºèœè°±
                </button>
            </div>

            <div class="mb-6 flex gap-3 items-center overflow-x-auto pb-2">
                <span class="text-gray-600 font-medium whitespace-nowrap">æŒ‰åˆ†ç±»ç­›é€‰:</span>
                <button 
                    @click="selectedRecipeCategory = ''" 
                    :class="{'bg-gray-700 text-white': selectedRecipeCategory === ''}"
                    class="px-3 py-1 rounded-full text-sm bg-gray-200 hover:bg-gray-300 transition whitespace-nowrap"
                >
                    å…¨éƒ¨ ({{ recipes.length }})
                </button>
                <button 
                    v-for="cat in availableRecipeCategories" 
                    :key="cat"
                    @click="selectedRecipeCategory = cat" 
                    :class="{'bg-primary text-white': selectedRecipeCategory === cat}"
                    class="px-3 py-1 rounded-full text-sm bg-gray-200 hover:bg-gray-300 transition whitespace-nowrap"
                >
                    {{ cat }}
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div 
                    v-for="(recipe, index) in filteredRecipes" 
                    :key="recipe.id" 
                    class="bg-white rounded-xl shadow hover:shadow-lg transition p-5 border"
                    :class="getRecipeCategoryColor(recipe.category)"
                >
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">{{ recipe.name }}</h3>
                        <div class="flex space-x-2">
                            <button @click="openRecipeEditor(recipe)" class="text-blue-500 text-sm">ç¼–è¾‘</button>
                            <button @click="deleteRecipe(recipe.id)" class="text-red-500 text-sm">åˆ é™¤</button>
                        </div>
                    </div>
                    
                    <div class="space-y-1">
                        <div v-for="ing in recipe.ingredients" :key="ing.name" class="flex justify-between text-sm text-gray-600 border-b border-dashed border-gray-200 pb-1 last:border-0">
                            <span>{{ ing.name }}
                                <span v-if="ing.optional" class="text-xs text-gray-400">(å¯é€‰)</span>
                            </span>
                            <span>x {{ ing.qty }} {{ ing.unit }}</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-xs font-medium" :class="getMonthlyUsage(recipe.id) > 0 ? 'text-primary-dark' : 'text-gray-500'">
                            æœ¬æœˆå·²ç‚¹: 
                            <span class="font-bold">{{ getMonthlyUsage(recipe.id) }}</span> æ¬¡
                        </span>

                        <span v-if="checkCookable(recipe)" class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-bold flex items-center">
                            âœ… åº“å­˜å……è¶³
                        </span>
                        <span v-else class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">
                            ç¼ºé£Ÿæ
                        </span>
                    </div>
                </div>
            </div>
            
            <div v-if="filteredRecipes.length === 0" class="text-center text-gray-400 py-10">
                å½“å‰åˆ†ç±»ä¸‹æ²¡æœ‰èœè°±ã€‚
            </div>
        </div>

    </main>
    
    <div v-if="showSelector" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @click.self="showSelector = false">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">é€‰æ‹©æ·»åŠ åˆ° {{ selectedDay }} çš„èœå“</h3>
                <button @click="showSelector = false" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 space-y-3">
                <input v-model="searchQuery" placeholder="æœç´¢èœè°±..." class="w-full border rounded px-3 py-2 mb-2">
                
                <div 
                    v-for="recipe in filteredRecipesInSelector" 
                    :key="recipe.id" 
                    @click="addToPlan(recipe.id)"
                    class="p-3 rounded-lg border cursor-pointer hover:bg-gray-50 flex justify-between items-center transition"
                    :class="{'border-green-300 bg-green-50': checkCookable(recipe), 'border-gray-200': !checkCookable(recipe)}"
                >
                    <div>
                        <div class="font-bold text-gray-800">{{ recipe.name }}</div>
                        <div class="text-xs text-gray-500">{{ recipe.ingredients.map(i => `${i.name} (${i.qty}${i.unit})`).join(', ') }}</div>
                    </div>
                    <div v-if="checkCookable(recipe)" class="text-green-600 text-sm font-bold bg-white px-2 py-1 rounded shadow-sm">
                        å¯åˆ¶ä½œ
                    </div>
                </div>
                
                <div v-if="filteredRecipesInSelector.length === 0" class="text-center text-gray-400 py-4">
                    æœªæ‰¾åˆ°èœè°±ï¼Œè¯·å…ˆå»â€œèœè°±ç®¡ç†â€æ·»åŠ 
                </div>
            </div>
        </div>
    </div>

    <div v-if="showRecipeEditor" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @click.self="closeRecipeEditor">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="font-bold text-xl mb-4">{{ editingRecipe.id ? 'ç¼–è¾‘èœè°±' : 'åˆ›å»ºæ–°èœè°±' }}</h3>
            
            <div class="mb-4 grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">èœè°±åç§°</label>
                    <input v-model="editingRecipe.name" class="w-full border rounded px-3 py-2 focus-ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">èœè°±åˆ†ç±»</label>
                    <input 
                        v-model="editingRecipe.category" 
                        list="recipe-categories"
                        class="w-full border rounded px-3 py-2 focus-ring-primary"
                        placeholder="è¾“å…¥æ–°åˆ†ç±»æˆ–é€‰æ‹©..."
                    >
                    <datalist id="recipe-categories">
                        <option v-for="cat in availableRecipeCategories" :key="cat" :value="cat"></option>
                    </datalist>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">æ‰€éœ€é£Ÿææ¸…å• (å¯æ‹–åŠ¨æ’åº)</label>
                <div class="space-y-2 max-h-60 overflow-y-auto mb-2 border p-2 rounded">
                    <div 
                        v-for="(ing, idx) in editingRecipe.ingredients" 
                        :key="idx" 
                        class="flex gap-2 items-center p-1 bg-white rounded border border-gray-100 hover:bg-gray-50 transition cursor-move"
                        draggable="true" 
                        @dragstart="dragStart(idx)"
                        @dragover.prevent
                        @drop="dropItem(idx)"
                    >
                        <span class="text-gray-400 text-lg hover:text-gray-600 mr-1 select-none">â˜°</span> 
                        
                        <input v-model="ing.name" placeholder="é£Ÿæå" class="flex-1 border rounded px-2 py-1 text-sm">
                        <input v-model.number="ing.qty" type="number" placeholder="æ•°é‡" class="w-16 border rounded px-2 py-1 text-sm">
                        <input v-model="ing.unit" placeholder="å•ä½" class="w-14 border rounded px-2 py-1 text-sm">
                        
                        <div class="flex items-center space-x-1">
                            <input type="checkbox" v-model="ing.optional" class="h-4 w-4 text-primary border-gray-300 rounded focus-ring-primary cursor-pointer">
                            <span class="text-xs text-gray-600 select-none">å¯é€‰</span>
                        </div>
                        
                        <button @click="removeIngFromEdit(idx)" class="text-red-500 hover:bg-red-50 px-2 rounded">Ã—</button>
                    </div>
                </div>
                <button @click="addIngToEdit" class="text-sm text-primary font-medium hover:underline">+ å¢åŠ ä¸€è¡Œé£Ÿæ</button>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button @click="closeRecipeEditor" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                <button @click="saveRecipe" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div v-if="recipeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @click.self="recipeDetailModal = null">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            
            <div v-if="recipeDetailModal.type === 'day'">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-2xl">{{ recipeDetailModal.day }} çš„æ¶ˆè€—è¯¦æƒ…</h3>
                    <button @click="recipeDetailModal = null" class="text-gray-500 text-2xl">&times;</button>
                </div>
                
                <div v-if="getDayRecipes(recipeDetailModal.day).length === 0" class="text-center text-gray-400 py-10">
                    å½“å¤©æ²¡æœ‰å®‰æ’ä»»ä½•èœè‚´
                </div>

                <div v-else class="space-y-6">
                    <div v-for="(meal, idx) in plan[recipeDetailModal.day]" :key="idx" class="border rounded-lg p-4" :class="{'bg-violet-50 border-violet-300': meal.status === 'å·²åˆ¶ä½œ', 'bg-gray-50': meal.status !== 'å·²åˆ¶ä½œ'}">
                        <h4 class="font-bold text-lg text-primary-dark mb-2">{{ getRecipeName(meal.id) }}</h4>
                        <p class="text-sm text-gray-500 mb-2">çŠ¶æ€: <span class="font-bold" :class="{'text-primary-dark': meal.status === 'å·²åˆ¶ä½œ'}">{{ meal.status }}</span></p>
                        <p class="text-xs text-gray-500 mb-2">æ‰€éœ€é£Ÿæ:</p>
                        <ul class="list-disc list-inside text-sm text-gray-700">
                            <li v-for="ing in getRecipe(meal.id).ingredients" :key="ing.name">
                                {{ ing.name }}
                                <span v-if="ing.optional" class="text-xs text-gray-400">(å¯é€‰)</span>: 
                                {{ ing.qty }} {{ ing.unit }}
                                <span v-if="!ing.optional && meal.status === 'æœªåˆ¶ä½œ' && getInventoryQty(ing.name) < ing.qty" class="text-red-500 text-xs font-bold ml-2">
                                    (ç¼º {{ getMissingQty(ing.name, ing.qty) }} {{ ing.unit }})
                                </span>
                                <span v-else-if="!ing.optional && meal.status === 'å·²åˆ¶ä½œ'" class="text-primary-dark text-xs ml-2">å·²æ‰£é™¤</span>
                                <span v-else class="text-green-600 text-xs ml-2">âœ“</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                     <button @click="recipeDetailModal = null" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">å…³é—­</button>
                </div>

            </div>

            <div v-else-if="recipeDetailModal.type === 'recipe'">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-2xl text-primary-dark">{{ recipeDetailModal.recipe.name }}</h3>
                    <button @click="recipeDetailModal = null" class="text-gray-500 text-2xl">&times;</button>
                </div>
                
                <p class="text-sm text-gray-500 mb-4">
                    åˆ†ç±»: 
                    <span class="px-2 py-1 rounded text-xs font-bold" :class="getRecipeCategoryColor(recipeDetailModal.recipe.category)">
                        {{ recipeDetailModal.recipe.category || 'æœªåˆ†ç±»' }}
                    </span>
                    <span class="ml-4 text-primary-dark font-bold">æœ¬æœˆå·²ç‚¹: {{ getMonthlyUsage(recipeDetailModal.recipe.id) }} æ¬¡</span>
                </p>

                <div class="space-y-4">
                    <h4 class="font-bold text-lg border-b pb-1">æ‰€éœ€é£Ÿæ</h4>
                    <ul class="space-y-2">
                        <li v-for="ing in recipeDetailModal.recipe.ingredients" :key="ing.name" class="p-2 border rounded flex justify-between items-center" :class="{'bg-gray-50': !ing.optional, 'bg-white': ing.optional}">
                            <span class="font-medium">{{ ing.name }}
                                <span v-if="ing.optional" class="text-xs text-gray-400">(å¯é€‰)</span>
                            </span>
                            <div class="flex items-center">
                                <span class="text-sm text-gray-700 mr-4">{{ ing.qty }} {{ ing.unit }}</span>
                                <span v-if="getInventoryQty(ing.name) < ing.qty" class="text-red-500 text-xs font-bold">
                                    (ç¼º {{ getMissingQty(ing.name, ing.qty) }} {{ ing.unit }})
                                </span>
                                <span v-else class="text-green-600 text-xs">åº“å­˜å……è¶³</span>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div class="mt-6 flex justify-end">
                     <button @click="recipeDetailModal = null" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">å…³é—­</button>
                </div>
            </div>

        </div>
    </div>


</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // --- Firebase åˆå§‹åŒ–é…ç½® (å·²å®Œæˆ) ---
    // ----------------------------------------------------
    // ã€æ‚¨çš„ Firebase é…ç½®ã€‘
    const firebaseConfig = {
      apiKey: "AIzaSyBJPV0a2CpU2BIzk7WnMv92hHDwVBp25Lk",
      authDomain: "mealhelp-171d4.firebaseapp.com",
      projectId: "mealhelp-171d4",
      storageBucket: "mealhelp-171d4.firebasestorage.app",
      messagingSenderId: "390055396732",
      appId: "1:390055396732:web:d036a7a20a469fafd6d0f9",
      measurementId: "G-SZW2X6XXH4"
    };
    // ----------------------------------------------------
    
    // åˆå§‹åŒ– Firebase å’Œ Firestore å®ä¾‹
    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore();
    const dataRef = db.collection('meal-planners').doc('shared-data'); // ä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„æ–‡æ¡£æ¥å­˜å‚¨æ‰€æœ‰å…±äº«æ•°æ®
    // ----------------------------------------------------


    // --- å…¨å±€é…ç½®å¸¸é‡ (æœªä¿®æ”¹) ---
    const CATEGORIES_MAP = {
        'è°ƒæ–™ç±»': { priority: 1, items: ['ç›', 'ç³–', 'é…±æ²¹', 'æ²¹'] },
        'èœç±»': { priority: 2, items: ['ç™½èœ', 'ç”Ÿèœ', 'åœŸè±†', 'èƒ¡èåœ'] },
        'é±¼ç±»': { priority: 3, items: ['å¸¦é±¼', 'é²ˆé±¼', 'è™¾'] },
        'è‚‰ç±»': { priority: 4, items: ['çŒªäº”èŠ±è‚‰', 'é¸¡èƒ¸è‚‰', 'ç‰›è‚‰', 'æ’éª¨'] },
        'ä¸»é£Ÿç±»': { priority: 5, items: ['ç±³é¥­', 'é¢æ¡', 'é¢åŒ…'] },
    };
    
    const CATEGORY_COLORS_MAP = {
        'å®¶å¸¸èœ': 'bg-blue-100 text-blue-800 border-blue-200',
        'å¿«æ‰‹é¤': 'bg-green-100 text-green-800 border-green-200',
        'çƒ˜ç„™ç”œç‚¹': 'bg-pink-100 text-pink-800 border-pink-200',
        'æ±¤ç¾¹ç±»': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'é¥®å“': 'bg-purple-100 text-purple-800 border-purple-200',
        'æœªåˆ†ç±»': 'bg-gray-100 text-gray-700 border-gray-200'
    };
    
    const DEFAULT_SHELF_LIFE_DAYS = {
        'èœç±»': 7, 'è‚‰ç±»': 5, 'é±¼ç±»': 3, 'è°ƒæ–™ç±»': 365, 'ä¸»é£Ÿç±»': 30
    };
    const BASIC_INGREDIENTS = [
        {name: 'æ²¹', qty: 1, unit: 'å‹º', optional: false}, 
        {name: 'ç›', qty: 1, unit: 'å…‹', optional: false}
    ];
    const EXPIRING_SOON_THRESHOLD = 3;

    createApp({
        setup() {
            // --- çŠ¶æ€æ•°æ® ---
            const currentTab = ref('plan'); 
            const weekDays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
            
            // æ ¸å¿ƒæ•°æ®æ¨¡å‹
            const inventory = ref([]); 
            const recipes = ref([]);   
            const plan = ref({
                'å‘¨ä¸€': [], 'å‘¨äºŒ': [], 'å‘¨ä¸‰': [], 'å‘¨å››': [], 'å‘¨äº”': [], 'å‘¨å…­': [], 'å‘¨æ—¥': []
            });
            const recipeStats = ref({}); 
            const isDataLoaded = ref(false); // æ–°å¢çŠ¶æ€ï¼šæ•°æ®æ˜¯å¦å·²ä»äº‘ç«¯åŠ è½½

            // UIæ§åˆ¶çŠ¶æ€ (æœªä¿®æ”¹)
            const showSelector = ref(false);
            const selectedDay = ref('');
            const searchQuery = ref('');
            const showRecipeEditor = ref(false);
            const editingRecipe = ref({ id: null, name: '', ingredients: [], category: '' });
            const recipeDetailModal = ref(null);
            const selectedRecipeCategory = ref(''); 
            const draggedIndex = ref(null); 
            
            // åº“å­˜æ·»åŠ è¾“å…¥æ¡† (æœªä¿®æ”¹)
            const newInvCategory = ref('');
            const newInvName = ref('');
            const newInvQty = ref('');
            const newInvUnit = ref('');
            const newInvShelfLife = ref('');
            
            // å“åº”å¼åˆ¤æ–­ (æ–°å¢)
            const isDesktop = ref(window.innerWidth >= 768); // md breakpoint in Tailwind

            const handleResize = () => {
                isDesktop.value = window.innerWidth >= 768;
            };

            onMounted(() => {
                window.addEventListener('resize', handleResize);
                // å¯åŠ¨æ—¶ä» Firebase åŠ è½½æ•°æ®
                loadDataFromFirestore();
            });
            
            // --- Firebase æ•°æ®åŠ è½½å’ŒåŒæ­¥ ---
            
            // æ•°æ®åŠ è½½ï¼šä» Firestore è¯»å–
            const loadDataFromFirestore = () => {
                 dataRef.onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // ä½¿ç”¨è§£æ„èµ‹å€¼ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´
                        inventory.value = data.inventory || [];
                        recipes.value = data.recipes || [];
                        plan.value = data.plan || {'å‘¨ä¸€': [], 'å‘¨äºŒ': [], 'å‘¨ä¸‰': [], 'å‘¨å››': [], 'å‘¨äº”': [], 'å‘¨å…­': [], 'å‘¨æ—¥': []};
                        recipeStats.value = data.recipeStats || {};
                        
                        // æ¸…é™¤æ—§çš„ localStorage æ•°æ®ï¼Œç¡®ä¿ä¸å†ä½¿ç”¨æœ¬åœ°å­˜å‚¨
                        localStorage.removeItem('mp_inventory_v2');
                        localStorage.removeItem('mp_recipes_v2');
                        localStorage.removeItem('mp_plan_v2');
                        localStorage.removeItem('mp_recipe_stats_v2');
                    } else {
                         // å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼Œåˆ™è®¾ç½®åˆå§‹æ•°æ® (ç©º)
                         dataRef.set({
                            inventory: inventory.value,
                            recipes: recipes.value,
                            plan: plan.value,
                            recipeStats: recipeStats.value,
                         });
                    }
                    isDataLoaded.value = true;
                    console.log("æ•°æ®å·²ä» Firestore åŠ è½½/åŒæ­¥ã€‚");
                }, err => {
                    console.error("Firestore åŒæ­¥é”™è¯¯:", err);
                    isDataLoaded.value = false;
                });
            };

            // æ•°æ®ä¿å­˜ï¼šå†™å…¥ Firestore
            // ç›‘å¬æ‰€æœ‰æ ¸å¿ƒæ•°æ®çš„å˜åŒ–ï¼Œå¹¶æ‰§è¡Œä¸€æ¬¡æ€§çš„å†™å…¥æ“ä½œ (å–ä»£ localStorage)
            const saveDataToFirestore = () => {
                if (!isDataLoaded.value) return; // ç¡®ä¿æ•°æ®åŠ è½½å®Œæˆåå†è¿›è¡Œå†™å…¥
                
                // Firestore set æ–¹æ³•ä¼šæ›¿æ¢æ•´ä¸ªæ–‡æ¡£ï¼Œä½†ç”±äºæˆ‘ä»¬åªå­˜å‚¨ä¸€ä¸ªæ–‡æ¡£ï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„
                dataRef.set({
                    inventory: inventory.value,
                    recipes: recipes.value,
                    plan: plan.value,
                    recipeStats: recipeStats.value,
                })
                .then(() => {
                    // console.log("æ•°æ®æˆåŠŸå†™å…¥ Firestore!");
                })
                .catch(error => {
                    console.error("å†™å…¥ Firestore é”™è¯¯:", error);
                });
            };
            
            // ç›‘å¬å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜åˆ° Firestore
            watch([inventory, recipes, plan, recipeStats], saveDataToFirestore, { deep: true });

            // --- å·¥å…·å‡½æ•° (æœªä¿®æ”¹) ---
            const getToday = () => new Date().toISOString().slice(0, 10);
            const getCurrentYearMonth = () => new Date().toISOString().slice(0, 7);
            const getRecipeCategoryColor = (category) => {
                return CATEGORY_COLORS_MAP[category] || CATEGORY_COLORS_MAP['æœªåˆ†ç±»'];
            };
            const addDays = (dateStr, days) => {
                const date = new Date(dateStr);
                date.setDate(date.getDate() + days);
                return date.toISOString().slice(0, 10);
            };
            const getDaysDifference = (targetDateStr) => {
                const today = new Date(getToday());
                const target = new Date(targetDateStr);
                const diffTime = target - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };
            const getRecipe = (id) => recipes.value.find(r => r.id === id);


            // ç±»åˆ«è¾“å…¥ç›‘å¬ (å·²ä¿®æ­£é€»è¾‘)
            watch(newInvCategory, (newCat) => {
                if (DEFAULT_SHELF_LIFE_DAYS[newCat]) {
                    newInvShelfLife.value = DEFAULT_SHELF_LIFE_DAYS[newCat];
                } else if (newCat && newCat.trim() !== '' && !DEFAULT_SHELF_LIFE_DAYS[newCat]) { 
                    newInvShelfLife.value = 7;
                } else {
                    newInvShelfLife.value = '';
                }
                newInvName.value = '';
            });

            // --- æ—¥æœŸè®¡ç®—å’Œå‘¨è®¡åˆ’é«˜äº®é€»è¾‘ (æœªä¿®æ”¹) ---
            const getWeekStart = () => {
                const today = new Date();
                const day = today.getDay(); 
                const diff = day === 0 ? -6 : 1 - day;
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() + diff);
                return weekStart;
            };
            
            const datedWeekDays = computed(() => {
                const start = getWeekStart();
                const todayStr = getToday();
                
                return weekDays.map((dayName, index) => {
                    const date = new Date(start);
                    date.setDate(start.getDate() + index);
                    const dateStr = date.toISOString().slice(0, 10);
                    
                    const isToday = dateStr === todayStr;
                    const isPast = date.getTime() < new Date(todayStr).getTime();
                    
                    return {
                        dayName,
                        dateStr,
                        displayDate: `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`,
                        isToday,
                        isPast
                    };
                });
            });


            // --- æ ¸å¿ƒé€»è¾‘è®¡ç®— (æœªä¿®æ”¹) ---
            const getInventoryQty = (name) => {
                const item = inventory.value.find(i => i.name === name);
                return item ? item.qty : 0;
            };
            
            const getMissingQty = (name, requiredQty) => Math.max(0, requiredQty - getInventoryQty(name));

            const checkCookable = (recipe) => {
                return recipe.ingredients.every(ing => ing.optional || getMissingQty(ing.name, ing.qty) === 0);
            };
            
            const totalUsage = computed(() => {
                const consumption = {};
                weekDays.forEach(dayName => {
                    (plan.value[dayName] || []).forEach(meal => {
                        if (meal.status !== 'å·²åˆ¶ä½œ') return; 
                        const recipe = recipes.value.find(r => r.id === meal.id);
                        if (recipe) {
                            recipe.ingredients.forEach(ing => {
                                if (!ing.optional) { 
                                    if (!consumption[ing.name]) {
                                        consumption[ing.name] = { qty: 0, unit: ing.unit };
                                    }
                                    consumption[ing.name].qty += ing.qty;
                                }
                            });
                        }
                    });
                });
                return consumption;
            });
            
            const shoppingList = computed(() => {
                const usage = {};
                datedWeekDays.value.forEach(dayData => {
                    if (dayData.isPast && !dayData.isToday) return; 
                    (plan.value[dayData.dayName] || []).forEach(meal => {
                        if (meal.status !== 'æœªåˆ¶ä½œ') return; 
                        const recipe = recipes.value.find(r => r.id === meal.id);
                        if (recipe) {
                            recipe.ingredients.forEach(ing => {
                                if (!usage[ing.name]) {
                                    usage[ing.name] = { qty: 0, unit: ing.unit, optional: ing.optional };
                                }
                                if (usage[ing.name].optional && !ing.optional) {
                                    usage[ing.name].optional = false;
                                }
                                usage[ing.name].qty += ing.qty;
                            });
                        }
                    });
                });
                
                const list = [];
                for (const [name, {qty: requiredQty, unit, optional}] of Object.entries(usage)) {
                    if (getInventoryQty(name) < requiredQty) {
                        list.push({
                            name: name,
                            missing: requiredQty - getInventoryQty(name),
                            unit: unit || 'ä»½',
                            optional: optional
                        });
                    }
                }
                list.sort((a, b) => (a.optional === b.optional) ? 0 : a.optional ? 1 : -1);
                return list;
            });

            const checkDaysLeft = (item) => {
                if (!item.shelfLife || !item.entryDate) return 999;
                const expiryDate = addDays(item.entryDate, item.shelfLife);
                return getDaysDifference(expiryDate);
            };

            const checkExpirationStatus = (item) => {
                const daysLeft = checkDaysLeft(item);
                if (daysLeft < 0) return 'expired';
                if (daysLeft <= EXPIRING_SOON_THRESHOLD) return 'expiring-soon';
                return '';
            };

            const filteredRecipes = computed(() => {
                let list = recipes.value;
                if (selectedRecipeCategory.value) {
                    list = list.filter(r => r.category === selectedRecipeCategory.value);
                }
                return list;
            });
            
            const filteredRecipesInSelector = computed(() => {
                if (!searchQuery.value) return recipes.value;
                return recipes.value.filter(r => r.name.toLowerCase().includes(searchQuery.value.toLowerCase()));
            });

            const getMonthlyUsage = (recipeId) => {
                const currentMonth = getCurrentYearMonth();
                const stats = recipeStats.value[recipeId];
                return (stats && stats[currentMonth]) || 0;
            };


            // --- æ‹–æ‹½æ’åºæ–¹æ³• (æœªä¿®æ”¹) ---
            const dragStart = (index) => { draggedIndex.value = index; };
            const dropItem = (targetIndex) => {
                if (draggedIndex.value === null || draggedIndex.value === targetIndex) return;
                const itemToMove = editingRecipe.value.ingredients.splice(draggedIndex.value, 1)[0];
                editingRecipe.value.ingredients.splice(targetIndex, 0, itemToMove);
                draggedIndex.value = null;
            };

            // --- èœè°±æ“ä½œ (æœªä¿®æ”¹) ---
            const openRecipeEditor = (recipe = null) => {
                if (recipe) {
                    const copiedRecipe = JSON.parse(JSON.stringify(recipe));
                    if (typeof copiedRecipe.category === 'undefined') copiedRecipe.category = ''; 
                    copiedRecipe.ingredients.forEach(ing => {
                        if (typeof ing.optional === 'undefined') ing.optional = false;
                    });
                    editingRecipe.value = copiedRecipe;
                } else {
                    editingRecipe.value = { 
                        id: null, 
                        name: '', 
                        ingredients: JSON.parse(JSON.stringify(BASIC_INGREDIENTS)),
                        category: '' 
                    };
                }
                showRecipeEditor.value = true;
            };

            const addIngToEdit = () => editingRecipe.value.ingredients.push({name: '', qty: 1, unit: 'ä»½', optional: false});
            const removeIngFromEdit = (idx) => editingRecipe.value.ingredients.splice(idx, 1);
            const closeRecipeEditor = () => showRecipeEditor.value = false;
            
            const saveRecipe = () => {
                if (!editingRecipe.value.name) return alert('è¯·è¾“å…¥èœè°±åç§°');
                
                let finalIngredients = editingRecipe.value.ingredients.filter(i => i.name && i.qty > 0);
                
                BASIC_INGREDIENTS.forEach(basic => {
                    let existing = finalIngredients.find(i => i.name === basic.name);
                    if (!existing) {
                        finalIngredients.push(basic);
                    } else if (typeof existing.optional === 'undefined') {
                        existing.optional = basic.optional; 
                    }
                });
                
                finalIngredients.forEach(ing => {
                    if (typeof ing.optional === 'undefined') ing.optional = false;
                });
                
                editingRecipe.value.ingredients = finalIngredients;
                editingRecipe.value.category = editingRecipe.value.category.trim();

                if (editingRecipe.value.id) {
                    const idx = recipes.value.findIndex(r => r.id === editingRecipe.value.id);
                    if (idx !== -1) recipes.value[idx] = editingRecipe.value;
                } else {
                    editingRecipe.value.id = Date.now();
                    recipes.value.push(editingRecipe.value);
                }
                closeRecipeEditor();
            };
            const deleteRecipe = (id) => {
                if (confirm('ç¡®å®šåˆ é™¤æ­¤èœè°±ï¼Ÿ')) {
                    recipes.value = recipes.value.filter(r => r.id !== id);
                    Object.keys(plan.value).forEach(day => {
                        plan.value[day] = plan.value[day].filter(meal => meal.id !== id);
                    });
                    delete recipeStats.value[id];
                }
            };

            // 3. è®¡åˆ’æ“ä½œ (æœªä¿®æ”¹)
            const openMealSelector = (day) => {
                selectedDay.value = day;
                showSelector.value = true;
                searchQuery.value = '';
            };
            
            const addToPlan = (recipeId) => {
                plan.value[selectedDay.value].push({ id: recipeId, status: 'æœªåˆ¶ä½œ' });
                
                const currentMonth = getCurrentYearMonth();
                if (!recipeStats.value[recipeId]) {
                    recipeStats.value[recipeId] = {};
                }
                recipeStats.value[recipeId][currentMonth] = (recipeStats.value[recipeId][currentMonth] || 0) + 1;
                
                showSelector.value = false;
            };
            
            const removeFromPlan = (day, idx) => {
                const recipeId = plan.value[day][idx].id;
                plan.value[day].splice(idx, 1);
                
                const currentMonth = getCurrentYearMonth();
                if (recipeStats.value[recipeId] && recipeStats.value[recipeId][currentMonth] > 0) {
                    recipeStats.value[recipeId][currentMonth] -= 1;
                }
            };
            
            const clearPlan = () => {
                if(confirm('ç¡®å®šæ¸…ç©ºæœ¬å‘¨æ‰€æœ‰è®¡åˆ’å—ï¼Ÿ')) {
                    Object.keys(plan.value).forEach(d => plan.value[d] = []);
                }
            };
            
            const toggleRecipeStatus = (dayName, mealIndex) => {
                const meal = plan.value[dayName][mealIndex];
                const recipe = getRecipe(meal.id);
                
                if (!recipe) return alert('èœè°±ä¸å­˜åœ¨ï¼');

                if (meal.status === 'æœªåˆ¶ä½œ') {
                    meal.status = 'å·²åˆ¶ä½œ';
                    let deductedIngredients = [];

                    recipe.ingredients.forEach(ing => {
                        if (!ing.optional) { 
                            const itemIndex = inventory.value.findIndex(i => i.name === ing.name);
                            if (itemIndex !== -1) {
                                const inventoryItem = inventory.value[itemIndex];
                                const deductedQty = Math.min(inventoryItem.qty, ing.qty);
                                inventoryItem.qty = Math.max(0, inventoryItem.qty - ing.qty);
                                
                                if (deductedQty > 0) {
                                    deductedIngredients.push(`${ing.name}: ${deductedQty}${ing.unit}`);
                                }
                            }
                        }
                    });
                    if (deductedIngredients.length > 0) {
                        alert(`å·²å°† "${recipe.name}" æ ‡è®°ä¸ºã€å·²åˆ¶ä½œã€‘ï¼Œå¹¶æ‰£é™¤ä»¥ä¸‹åº“å­˜ï¼š\n${deductedIngredients.join('\n')}`);
                    } else {
                        alert(`å·²å°† "${recipe.name}" æ ‡è®°ä¸ºã€å·²åˆ¶ä½œã€‘ï¼Œæ— é£Ÿæéœ€è¦æ‰£é™¤ã€‚`);
                    }

                } else {
                    if (confirm('è­¦å‘Šï¼šå°†çŠ¶æ€æ›´æ”¹å›â€œæœªåˆ¶ä½œâ€ä¸ä¼šè‡ªåŠ¨å›æ»šåº“å­˜æ‰£é™¤ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                         meal.status = 'æœªåˆ¶ä½œ';
                    }
                }
            };
            
            const getRecipeName = (id) => {
                const r = getRecipe(id);
                return r ? r.name : 'æœªçŸ¥èœè°±';
            };
            const getRecipeIngredientsStr = (id) => {
                const r = getRecipe(id);
                if (!r) return '';
                return r.ingredients.map(i => `${i.name}${i.optional ? '(å¯é€‰)' : ''} (${i.qty}${i.unit})`).join(', ');
            };

            // 4. è¯¦æƒ…å¼¹çª— (é€šç”¨) (æœªä¿®æ”¹)
            
            const viewDayDetail = (day) => {
                recipeDetailModal.value = { type: 'day', day: day };
            };
            
            const viewRecipeDetail = (recipeId) => {
                const recipe = getRecipe(recipeId);
                if (recipe) {
                    recipeDetailModal.value = { type: 'recipe', recipe: recipe };
                }
            };
            
            const getDayRecipes = (day) => {
                return (plan.value[day] || []).map(meal => {
                    const recipe = getRecipe(meal.id);
                    return recipe ? { ...recipe, status: meal.status } : null;
                }).filter(Boolean);
            };

            // 5. åº“å­˜æ“ä½œ (æœªä¿®æ”¹)
            const addInventory = () => {
                if (!newInvName.value || !newInvQty.value || !newInvUnit.value || !newInvCategory.value) {
                    return alert('è¯·å¡«å†™å®Œæ•´çš„é£Ÿæä¿¡æ¯ (ç±»åˆ«ã€åç§°ã€æ•°é‡ã€å•ä½)');
                }

                const existing = inventory.value.find(i => i.name === newInvName.value);
                const entryDate = getToday();
                const shelfLife = parseInt(newInvShelfLife.value) || DEFAULT_SHELF_LIFE_DAYS[newInvCategory.value] || 7;

                if (existing) {
                    if (existing.unit !== newInvUnit.value) {
                         alert(`æ³¨æ„ï¼š"${newInvName.value}" çš„ç°æœ‰å•ä½æ˜¯ ${existing.unit}ï¼Œæœ¬æ¬¡å•ä½æ˜¯ ${newInvUnit.value}ï¼Œè¯·ä¿æŒå•ä½ä¸€è‡´æ€§ä»¥ç¡®ä¿è®¡ç®—å‡†ç¡®ï¼`);
                    }
                    existing.qty += newInvQty.value;
                    existing.entryDate = entryDate; 
                    existing.shelfLife = shelfLife;
                } else {
                    inventory.value.push({
                        name: newInvName.value,
                        qty: newInvQty.value,
                        unit: newInvUnit.value,
                        category: newInvCategory.value,
                        entryDate: entryDate,
                        shelfLife: shelfLife
                    });
                }
                newInvCategory.value = '';
                newInvName.value = '';
                newInvQty.value = '';
                newInvUnit.value = '';
                newInvShelfLife.value = '';
            };
            
            const updateInventory = (idx, change) => {
                const item = inventory.value[idx];
                const newVal = item.qty + change;
                if (newVal >= 0) item.qty = newVal;
            };
            
            const deleteInventory = (idx) => {
                if(confirm('ç¡®å®šåˆ é™¤è¯¥é£Ÿæå—ï¼Ÿ')) inventory.value.splice(idx, 1);
            };

            // 6. èœè°±åˆ†ç±»è®¡ç®— (æœªä¿®æ”¹)
             const availableRecipeCategories = computed(() => {
                const categories = new Set(recipes.value.map(r => r.category).filter(c => c));
                return Array.from(categories).sort();
            });


            return {
                CATEGORIES_MAP, CATEGORY_COLORS_MAP, weekDays, 
                currentTab, inventory, recipes, plan, recipeStats,
                isDataLoaded, isDesktop,
                showSelector, selectedDay, searchQuery,
                showRecipeEditor, editingRecipe,
                newInvCategory, newInvName, newInvQty, newInvUnit, newInvShelfLife,
                shoppingList, totalUsage,
                availableRecipeCategories, selectedRecipeCategory, filteredRecipes, filteredRecipesInSelector,
                datedWeekDays,
                dragStart, dropItem,
                addInventory, updateInventory, deleteInventory,
                openRecipeEditor, closeRecipeEditor, addIngToEdit, removeIngFromEdit, saveRecipe, deleteRecipe,
                openMealSelector, addToPlan, removeFromPlan, clearPlan,
                toggleRecipeStatus, 
                getRecipe, getRecipeName, getRecipeIngredientsStr, getRecipeCategoryColor, getMonthlyUsage,
                checkCookable, checkExpirationStatus, checkDaysLeft, getInventoryQty, getMissingQty,
                recipeDetailModal, viewDayDetail, viewRecipeDetail, getDayRecipes,
            };
        }
    }).mount('#app');
</script>

</body>
</html>
